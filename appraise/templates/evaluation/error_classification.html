{% extends "base.html" %}

{% block head %}
<script language="javascript" src="/appraise/site_media/jquery-1.7.1.min.js"></script>
<script language="javascript">
<!--
var ERROR_CLASSES = ["terminology", "lexical_choice", "syntax", "insertion",
  "morphology", "misspelling", "punctuation", "other"];

$(document).ready(function() {
  for (var i=0; i<{{words|length}}; i++)
  {
    $('#edit_'+i).hide();
    $('#view_'+i).html('<em>Click to classify errors for this word...</em>');
  }
});

function update_error_summary()
{
  var _errors = new Array();
  for (var i=0; i<ERROR_CLASSES.length; i++) {
    _total_errors_of_this_class = 0;
    for (var j=0; j<{{words|length}}; j++) {
      var _error = $('input[name="'+ERROR_CLASSES[i]+'_'+j+'"]:checked').val();

      if (_error != undefined)
        _total_errors_of_this_class += 1;
    }

    if (_total_errors_of_this_class > 0)
      _errors.push(_total_errors_of_this_class+'x '+ERROR_CLASSES[i].replace('_', ' '));
  }

  if (_errors.length)
    $('#error_summary').html(_errors.join('<br/>'));
}

function summarise_errors_for_word(id)
{
  var _errors = new Array();
  for (var i=0; i<ERROR_CLASSES.length; i++) {
    var _error = $('input[name="'+ERROR_CLASSES[i]+'_'+id+'"]:checked').val();
    if (_error != undefined)
      _errors.push(_error.toLowerCase()+' '+ERROR_CLASSES[i].replace('_', ' '));
  }

  if (_errors.length)
    $('#view_'+id).html(_errors.join(', '));
}

function toggle_classification(id)
{
  if ($('input[name="too_many_errors"]').attr('checked') == 'checked')
  {
    return;
  }

  for (var i=0; i<{{words|length}}; i++)
  {
    if (i == id) {
      $('#edit_'+i).show();
      $('#view_'+i).hide();
    }
    else if ($('#edit_'+i).css('display') == 'inline') {
      summarise_errors_for_word(i);

      $('#edit_'+i).hide();
      $('#view_'+i).show();
    }
  }

  update_error_summary();
}

function reset_form_if_too_many_errors_is_clicked(self)
{
  if (self.attr('checked') == 'checked') {
    reset_form();
    self.attr('checked', 'checked');
  }
}

function toggle_checkbox(input_name)
{
  var input = $('input[name="'+input_name+'"]');

  if (input.attr('checked') == 'checked')
    input.removeAttr('checked');
  else {
    if (input_name == 'too_many_errors') {
      reset_form();
    }
    input.attr('checked', 'checked');
  }
}

function reset_form()
{
  $('input[name="missing_words"]').removeAttr('checked');
  $('input[name="too_many_errors"]').removeAttr('checked');
  for (var i=0; i<{{words|length}}; i++)
  {
    $('#edit_'+i).hide();
    $('#view_'+i).html('<em>Click to classify errors for this word...</em>');
    $('#view_'+i).show();

    for (var j=0; j<ERROR_CLASSES.length; j++) {
      var _error = $('input[name="'+ERROR_CLASSES[j]+'_'+i+'"]').removeAttr('checked');
    }
  }
  $('#error_summary').html('<em>No errors classified yet...</em>');
  $('input[name="now"]').val(Date.now()/1000.0);
}

function validate_form()
{
  if ($('textarea[name="postedited"]').val() == '') {
{% if translations|length > 1 %}
    alert('Please post-edit one of the translations...');
{% else %}
    alert('Please post-edit the translation...');
{% endif %}
    return false;
  }

  return true;
}
-->
</script>
{% endblock %}

{% block content %}

<div class="alert-message success">
  <p id="task_progress">{{task_progress}}</p>
</div>

<p><em>TASK DESCRIPTION GOES HERE...</em> Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet.</p>


<div class="container">

{% if reference_text %}
<div class="span8">
<blockquote>
<p>Left context. Left context. Left context. Left context. Left context. Left context. <strong>{{source_text.0}}</strong> Right context. Right context. Right context. Right context. Right context. Right context.</p>
<small>Source</small>
</blockquote>
</div>
<div class="push8">
<blockquote>
<p>Left context. Left context. Left context. Left context. Left context. Left context.<strong>{{reference_text.0}}</strong> Right context. Right context. Right context. Right context. Right context. Right context.</p>
<small>Reference</small>
</blockquote>
</div>
{% else %}
<div class="push16">
<blockquote>
<p>Left context. Left context. Left context. Left context. Left context. Left context. <strong>{{source_text.0}}</strong> Right context. Right context. Right context. Right context. Right context. Right context.</p>
<small>Source</small>
</blockquote>
</div>
{% endif %}

<blockquote>
<p><strong>{{translations}} Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet.</strong></p>
<small>Translation (THIS COULD ALSO NOT BE SHOWN...)</small>
</blockquote>

<form action="" method="post">

<input name="item_id" type="hidden" value="{{item_id}}" />
<input name="now" type="hidden" value="{{now}}" />
<input name="words" type="hidden" value="{{words|length}}" />

<input name="missing_words" type="checkbox" value="MISSING_WORDS">
<span onclick="javascript:toggle_checkbox('missing_words');">Missing words</span>
<input onclick="javascript:reset_form_if_too_many_errors_is_clicked($(this));" name="too_many_errors" type="checkbox" value="TOO_MANY_ERRORS">
<span onclick="javascript:toggle_checkbox('too_many_errors');">Too many errors</span>

<div class="row">
<div class="span12">
<table id="words">
{% for word in words %}
<tr>
  <th onclick="javascript:toggle_classification({{forloop.counter0}});">{{word}}</th>
  <td width="100%">
{% with forloop.counter0 as word_id %}
{% include 'evaluation/word_classification.html' %}
{% endwith %}
  </td>
</tr>
{% endfor %}
</table>
</div>
<div class="span4">
<h4>Error Summary</h4>
<span id="error_summary"><em>No errors classified yet...</em></span>
</div>
</div>

<div class="actions">
  <button name="submit_button" accesskey="1" type="submit" class="btn" value="SUBMIT" onclick="javascript:return validate_form();">Submit</button>
  &nbsp;
  
  <button onclick="javascript:reset_form();" accesskey="2" type="reset" class="btn">Reset</button>
  &nbsp;
  
  <button name="submit_button" accesskey="3" type="submit" class="btn" value="FLAG_ERROR">Flag Error</button>
</div>

</form>

</div>

{% endblock %}
